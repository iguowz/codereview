# Git增量代码智能审查与测试用例生成系统 - 使用指南

## 🚀 项目简介

这是一个基于AI的Git增量代码智能审查与测试用例生成系统，能够：

- 🔍 **智能代码审查**：分析代码变更，识别潜在问题
- 🧪 **自动生成测试用例**：根据代码变更自动生成单元测试和场景测试
- 🌐 **支持多种Git平台**：GitHub、GitLab等
- ⚙️ **可配置Redis**：支持Redis和内存模式
- 🎯 **一键启动**：跨平台一键启动脚本

## 📁 项目结构

```
codeReview/
├── app/                    # 后端应用
│   ├── __init__.py        # Flask应用初始化
│   ├── routes.py          # API路由
│   ├── tasks.py           # Celery任务
│   ├── task_processor.py  # 任务处理器
│   ├── task_state.py      # 任务状态管理
│   ├── statistics.py      # 统计功能
│   ├── models.py          # 数据模型
│   ├── logger.py          # 日志系统
│   ├── config_manager.py  # 配置管理
│   ├── exceptions.py      # 异常定义
│   └── utils/             # 工具模块
│       ├── git_api.py     # Git API客户端
│       ├── llm_api.py     # LLM API客户端
│       ├── async_llm_api.py # 异步LLM API
│       └── crypto.py      # 加密工具
├── config/                # 配置文件
│   ├── systems.yaml       # 系统配置
│   └── prompts.yaml       # 提示词模板
├── static/                # 静态资源
│   ├── css/               # 样式文件
│   └── js/                # JavaScript文件
├── templates/             # 前端模板
│   └── index.html         # 主页面
├── docs/                  # 文档目录
├── main.py                # 主程序
├── start.sh               # Linux/Mac启动脚本
├── requirements.txt       # Python依赖
└── README.md              # 项目说明
```

## 🚀 快速启动

### Linux/Mac用户
```bash
# 给脚本执行权限（首次运行）
chmod +x start.sh

# 运行启动脚本
./start.sh
```

### 手动启动
```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 设置环境变量
export DEEPSEEK_API_KEY='your-api-key'

# 3. 可选：自定义端口（如果5001被占用）
export PORT=8080

# 4. 启动应用
python main.py
```

## ⚙️ 配置说明

### 环境变量
- `DEEPSEEK_API_KEY`: DeepSeek API密钥（必需）
- `USE_REDIS`: 是否使用Redis（可选，默认false）
- `PORT`: 服务器端口（可选，默认5001）
- `HOST`: 服务器主机（可选，默认0.0.0.0）
- `SECRET_KEY`: Flask密钥（可选，默认dev-secret-key）

### 配置文件
1. 编辑 `config/systems.yaml`，配置你的Git系统信息：
   ```yaml
   systems:
     - id: "your-system-id"
       name: "你的系统名称"
       git_provider: "github"  # 或 "gitlab"
       git_provider_url: "https://api.github.com"
       git_provider_token: "your-git-token"
       projects:
         - name: "你的项目名称"
           repo_url: "https://github.com/owner/repo"
   ```

## 🔧 任务队列配置

### MockCelery模式（推荐用于开发）
```bash
# 设置环境变量
export USE_REDIS=false

# 启动应用
python main.py
```

**特点**：
- ✅ 无需安装Redis
- ✅ 任务在后台线程中执行
- ✅ 支持任务状态查询
- ✅ 完全兼容Celery API

### 真实Celery模式（推荐用于生产）
```bash
# 1. 启动Redis
redis-server

# 2. 设置环境变量
export USE_REDIS=true

# 3. 启动Celery Worker
python celery_worker.py

# 4. 启动应用
python main.py
```

**特点**：
- ✅ 真正的分布式任务队列
- ✅ 任务状态持久化
- ✅ 支持多Worker并发
- ✅ 生产级稳定性

## 📝 日志系统

项目采用统一的日志管理系统，提供专业级的日志记录功能：

### 日志级别
- `DEBUG`: 调试信息
- `INFO`: 一般信息
- `WARNING`: 警告信息
- `ERROR`: 错误信息

### 使用方法
```python
from app.logger import info, error, warning, debug

# 简单日志
info("系统启动完成")
warning("配置文件缺失")
error("数据库连接失败")
debug("处理用户请求: /api/users")
```

## 🎯 主要功能

### 1. 代码审查
- 增量代码分析
- 潜在问题识别
- 代码质量评估
- 安全漏洞检测

### 2. 测试用例生成
- 单元测试生成
- 集成测试生成
- 边界条件测试
- 异常场景测试

### 3. Git集成
- 多平台支持（GitHub、GitLab）
- 增量变更检测
- 分支管理
- 提交历史分析

## 🚨 故障排除

### 常见问题

1. **Python版本问题**
   - 确保Python版本 >= 3.8
   - 使用 `python3` 命令

2. **依赖安装失败**
   - 检查网络连接
   - 使用国内镜像：`pip install -i https://pypi.tuna.tsinghua.edu.cn/simple/ -r requirements.txt`

3. **配置文件问题**
   - 确保 `config/systems.yaml` 存在
   - 检查YAML语法格式

4. **API密钥问题**
   - 设置正确的 `DEEPSEEK_API_KEY`
   - 检查API密钥是否有效

5. **端口占用问题**
   - 使用 `export PORT=8080` 指定其他端口
   - 检查端口是否被其他服务占用

### 日志查看
```bash
# 查看应用日志
tail -f logs/codereview.log

# 查看错误日志
tail -f logs/codereview_error.log
```

## 📞 技术支持

如果遇到问题，请：

1. 查看日志文件获取详细错误信息
2. 检查环境变量和配置文件
3. 确保所有依赖已正确安装
4. 参考本文档的故障排除部分

## 🔄 更新日志

- **v1.0.0**: 初始版本，支持基础代码审查功能
- **v1.1.0**: 添加测试用例生成功能
- **v1.2.0**: 支持多Git平台
- **v1.3.0**: 添加MockCelery模式，优化开发体验
